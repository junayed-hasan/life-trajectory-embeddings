# LifeEmbedding Backend API

FastAPI backend service for the LifeEmbedding project.

## Features

- **RESTful API** for accessing person data and life trajectories
- **3D Visualization Data** endpoint for frontend rendering
- **User Embedding Generation** - generate embeddings for user-provided life events
- **Similarity Search** - find similar historical figures
- **Cluster Analysis** - explore occupational clusters

## API Endpoints

### Health & Status

- `GET /` - Root endpoint with API info
- `GET /api/health` - Health check and service status

### Persons

- `GET /api/v1/persons` - List all persons (paginated, filterable by cluster)
- `GET /api/v1/person/{person_id}` - Get detailed person information

### Visualization

- `GET /api/v1/visualization` - Get complete 3D visualization dataset

### Clusters

- `GET /api/v1/clusters` - List all clusters with statistics
- `GET /api/v1/cluster/{cluster_id}` - Get specific cluster info

### User Embedding

- `POST /api/v1/generate-embedding` - Generate embedding for user's life events

## Setup

### 1. Install Dependencies

```bash
cd backend
pip install -r requirements.txt
```

### 2. Set Environment Variables

Make sure you're authenticated with GCP:

```bash
gcloud auth application-default login
```

### 3. Run the Server

```bash
# Development mode (with auto-reload)
uvicorn main:app --reload --host 0.0.0.0 --port 8080

# Production mode
uvicorn main:app --host 0.0.0.0 --port 8080 --workers 4
```

### 4. Access API Documentation

- **Interactive Docs**: http://localhost:8080/api/docs
- **ReDoc**: http://localhost:8080/api/redoc

## Testing

### Test with curl

```bash
# Health check
curl http://localhost:8080/api/health

# Get all persons (first 10)
curl http://localhost:8080/api/v1/persons?limit=10

# Get visualization data
curl http://localhost:8080/api/v1/visualization

# Get clusters
curl http://localhost:8080/api/v1/clusters

# Generate user embedding
curl -X POST http://localhost:8080/api/v1/generate-embedding \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test User",
    "description": "Software engineer and researcher",
    "life_events": [
      {
        "event_type": "education",
        "event_title": "BS in Computer Science",
        "start_date": "2010-09-01",
        "end_date": "2014-05-15",
        "organization": "MIT"
      },
      {
        "event_type": "employment",
        "event_title": "Software Engineer",
        "start_date": "2014-06-01",
        "organization": "Google"
      }
    ]
  }'
```

## Project Structure

```
backend/
├── main.py              # FastAPI application and routes
├── models.py            # Pydantic data models
├── database.py          # BigQuery database operations
├── embeddings.py        # Embedding generation service
├── requirements.txt     # Python dependencies
└── README.md           # This file
```

## Dependencies

- **FastAPI** - Modern web framework
- **Uvicorn** - ASGI server
- **Google Cloud BigQuery** - Database
- **Google Cloud Vertex AI** - Embedding generation
- **NumPy, scikit-learn, umap-learn** - ML operations

## Notes

- **User data is NOT stored** - embeddings generated via POST /api/v1/generate-embedding are ephemeral
- **CORS is enabled** for all origins (restrict in production)
- **PCA/UMAP models** must be available (generated by dim_reduction.py)
- **Rate limiting** not implemented (add in production)

## Production Deployment

See Phase 8 of plan_v1.md for containerization and Cloud Run deployment instructions.
